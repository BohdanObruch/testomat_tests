name: All Tests And Unified Report

permissions:
  contents: write

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '7 8 * * 1-5'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: all
        type: choice
        options:
          - smoke
          - regression
          - all

jobs:
  lint:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Run Ruff linter
        run: uv run ruff check .

      - name: Run Ruff formatter check
        run: uv run ruff format --check .

  run-playwright:
    uses: ./.github/workflows/playwright_ui_tests.yml
    with:
      test_suite: ${{ github.event_name == 'pull_request' && 'smoke' || github.event_name == 'schedule' && 'all' || inputs.test_suite }}
    secrets: inherit

  run-api:
    uses: ./.github/workflows/api_tests.yml
    with:
      test_suite: ${{ github.event_name == 'pull_request' && 'all' || github.event_name == 'schedule' && 'all' || inputs.test_suite }}
    secrets: inherit

  run-selenium:
    uses: ./.github/workflows/selenium_tests.yml
    with:
      test_suite: ${{ github.event_name == 'pull_request' && 'all' || github.event_name == 'schedule' && 'all' || inputs.test_suite }}
    secrets: inherit

  publish-report:
    runs-on: ubuntu-latest
    needs: [ run-playwright, run-api, run-selenium ]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Playwright smoke Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: playwright-smoke-allure-results
          path: allure-results/playwright/smoke

      - name: Download Playwright regression Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: playwright-regression-allure-results
          path: allure-results/playwright/regression

      - name: Download API smoke Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: api-smoke-allure-results
          path: allure-results/api/smoke

      - name: Download API regression Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: api-regression-allure-results
          path: allure-results/api/regression

      - name: Download Selenium smoke Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: selenium-smoke-allure-results
          path: allure-results/selenium/smoke

      - name: Download Selenium regression Allure results
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: selenium-regression-allure-results
          path: allure-results/selenium/regression

      - name: Merge Allure results
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p allure-results/merged
          shopt -s nullglob
          for dir in allure-results/*/*; do
            if [ -d "$dir" ]; then
              cp -R "$dir"/. allure-results/merged/ || true
            fi
          done
          if ! find allure-results/merged -type f -name '*-result.json' | grep -q .; then
            echo "{}" > allure-results/merged/.placeholder.json
          fi

      - name: Generate Allure report with history
        if: always()
        id: allure-report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results/merged
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Publish Allure history to gh-pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
