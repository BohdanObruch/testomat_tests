name: 'Publish Allure reports to GitHub Pages'
description: 'Download Allure results, generate Allure 3 reports, and deploy to GitHub Pages.'

inputs:
  report-title:
    description: 'Title shown on the index page'
    required: true
  artifact-prefix-1:
    description: 'Primary artifact prefix, for example: playwright'
    required: true
  suite-mode-1:
    description: 'Expected suite mode for prefix 1: smoke, regression, all'
    required: false
    default: 'all'
  artifact-prefix-2:
    description: 'Optional second artifact prefix, for example: api'
    required: false
    default: ''
  suite-mode-2:
    description: 'Expected suite mode for prefix 2: smoke, regression, all'
    required: false
    default: 'all'
  artifact-prefix-3:
    description: 'Optional third artifact prefix, for example: selenium'
    required: false
    default: ''
  suite-mode-3:
    description: 'Expected suite mode for prefix 3: smoke, regression, all'
    required: false
    default: 'all'

outputs:
  page_url:
    description: 'Published GitHub Pages URL'
    value: ${{ steps.deployment.outputs.page_url }}

runs:
  using: 'composite'
  steps:
    - name: Download ${{ inputs.artifact-prefix-1 }} smoke Allure results
      if: inputs.suite-mode-1 != 'regression'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-1 }}-smoke-allure-results
        path: allure-results/${{ inputs.artifact-prefix-1 }}/smoke

    - name: Download ${{ inputs.artifact-prefix-1 }} regression Allure results
      if: inputs.suite-mode-1 != 'smoke'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-1 }}-regression-allure-results
        path: allure-results/${{ inputs.artifact-prefix-1 }}/regression

    - name: Download ${{ inputs.artifact-prefix-2 }} smoke Allure results
      if: inputs.artifact-prefix-2 != '' && inputs.suite-mode-2 != 'regression'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-2 }}-smoke-allure-results
        path: allure-results/${{ inputs.artifact-prefix-2 }}/smoke

    - name: Download ${{ inputs.artifact-prefix-2 }} regression Allure results
      if: inputs.artifact-prefix-2 != '' && inputs.suite-mode-2 != 'smoke'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-2 }}-regression-allure-results
        path: allure-results/${{ inputs.artifact-prefix-2 }}/regression

    - name: Download ${{ inputs.artifact-prefix-3 }} smoke Allure results
      if: inputs.artifact-prefix-3 != '' && inputs.suite-mode-3 != 'regression'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-3 }}-smoke-allure-results
        path: allure-results/${{ inputs.artifact-prefix-3 }}/smoke

    - name: Download ${{ inputs.artifact-prefix-3 }} regression Allure results
      if: inputs.artifact-prefix-3 != '' && inputs.suite-mode-3 != 'smoke'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-prefix-3 }}-regression-allure-results
        path: allure-results/${{ inputs.artifact-prefix-3 }}/regression

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Generate unified Allure 3 report
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p pages

        prefixes=("${{ inputs.artifact-prefix-1 }}")
        if [ -n "${{ inputs.artifact-prefix-2 }}" ]; then
          prefixes+=("${{ inputs.artifact-prefix-2 }}")
        fi
        if [ -n "${{ inputs.artifact-prefix-3 }}" ]; then
          prefixes+=("${{ inputs.artifact-prefix-3 }}")
        fi

        result_dirs=()
        for prefix in "${prefixes[@]}"; do
          for suite in smoke regression; do
            result_dir="allure-results/${prefix}/${suite}"
            if [ -d "$result_dir" ] && find "$result_dir" -type f -name '*-result.json' | grep -q .; then
              result_dirs+=("$result_dir")
            fi
          done
        done

        if [ "${#result_dirs[@]}" -gt 0 ]; then
          merged_dir="allure-results/merged"
          rm -rf "$merged_dir"
          mkdir -p "$merged_dir"

          for dir in "${result_dirs[@]}"; do
            cp -R "$dir"/. "$merged_dir"/
          done

          python - <<'PY'
  import json
  from pathlib import Path
  
  root = Path("allure-results/merged")
  by_key = {}
  to_delete = []

for file in root.glob("*-result.json"):
  try:
    data = json.loads(file.read_text(encoding="utf-8"))
  except Exception:
    continue

  history_id = data.get("historyId")
  full_name = data.get("fullName") or data.get("name") or file.name
  params = data.get("parameters") or []
  params_key = tuple(sorted((p.get("name"), str(p.get("value"))) for p in params if isinstance(p, dict)))
  key = history_id or (full_name, params_key)
  
  time = data.get("time") or {}
  stop = int(time.get("stop") or 0)
  start = int(time.get("start") or 0)
  rank = (stop, start)

  if key not in by_key:
    by_key[key] = (rank, file)
    continue

  existing_rank, existing_file = by_key[key]
  if rank >= existing_rank:
    to_delete.append(existing_file)
    by_key[key] = (rank, file)
  else:
    to_delete.append(file)

for file in to_delete:
  try:
    file.unlink()
  except FileNotFoundError:
    pass
  PY
  
  npx --yes allure@3 generate "$merged_dir" -o pages
  else
  cat > pages/index.html <<'HTML'
  <!doctype html>
  <html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Allure results</title>
  </head>
  <body>
  <h1>No Allure results available</h1>
  <p>No suite produced valid <code>*-result.json</code> files in this run.</p>
  </body>
  </html>
  HTML
  fi

  - name: Configure Pages
    uses: actions/configure-pages@v5

  - name: Upload Pages artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: pages

  - name: Deploy to GitHub Pages
    id: deployment
    uses: actions/deploy-pages@v4
